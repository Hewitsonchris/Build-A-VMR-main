!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).rexrestorabledataplugin=t()}(this,function(){"use strict";function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function u(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function e(e,t,r){return t&&i(e.prototype,t),r&&i(e,r),e}function n(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&s(e,t)}function l(e){return(l=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function s(e,t){return(s=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function h(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function c(i){var n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],function(){})),!0}catch(e){return!1}}();return function(){var e,t=l(i);if(n){var r=l(this).constructor;e=Reflect.construct(t,arguments,r)}else e=t.apply(this,arguments);return function(e,t){if(t&&("object"==typeof t||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return h(e)}(this,e)}}function f(e,t,r){return(f="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,r){var i=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=l(e)););return e}(e,t);if(i){var n=Object.getOwnPropertyDescriptor(i,t);return n.get?n.get.call(r):n.value}})(e,t,r||e)}function v(e){if("object"!==r(e)||null===e)return e;if(Array.isArray(e))e.length=0;else for(var t in e)delete e[t];return e}var t=Phaser.Data.DataManager,y=Phaser.Utils.Objects.GetValue,_=Phaser.Events.EventEmitter,o=function(){n(a,t);var o=c(a);function a(e,t,r){var i;u(this,a);var n=void 0===t;if(n&&(t=new _),i=o.call(this,e,t),n){var s=e.events?e.events:e;s&&s.once("destroy",i.destroy,h(i))}return i._recordEnable=!0,i.resetFromJSON(r),i.events.on("changedata",i.onValueChange,h(i)).on("setdata",function(e,t,r){this.onValueChange(e,t,r,null)},h(i)).on("removedata",function(e,t,r){this.onValueChange(e,t,null,r)},h(i)),i}return e(a,[{key:"resetFromJSON",value:function(e){this._version=y(e,"version",0),this._versionAlias=y(e,"versionAlias",""),this._repository=y(e,"repository",[]),this._versionAliases=y(e,"versionAliases",{});var t=y(e,"changeList",{}),r=y(e,"data",void 0);if(r)this._recordEnable=!1,this.set(r),this._recordEnable=!0;else{var i=""!==this._versionAlias?this._versionAlias:this._version;for(var n in this._version=0,this.restore(i),this._recordEnable=!1,t)this.setValue(n,t[n][0]);this._recordEnable=!0}this._changeList=t}},{key:"toJSON",value:function(e){void 0===e&&(e=!1);var t={version:this._version,versionAlias:this._versionAlias,changeList:this._changeList,repository:this._repository,versionAliases:this._versionAliases};return e&&(t.data=this.list),t}},{key:"version",get:function(){return this._version},set:function(e){var t;if("string"==typeof e&&(t=e,e=this._versionAliases[e]),"number"==typeof e){if(this._versionAlias=t||"",0===e)return this._recordEnable=!1,f(l(a.prototype),"reset",this).call(this),this._version=0,v(this._changeList),void(this._recordEnable=!0);e=Math.min(e,this._repository.length);var r,i={};for(var n in this._changeList)i[n]=this._changeList[n][1],delete this._changeList[n];if(this._version!==e)if(this._version<e)for(var s=this._version;s<e;s++)for(var n in r=this._repository[s])i[n]=r[n][0];else for(s=this._version-1;e<=s;s--)for(var n in r=this._repository[s])i[n]=r[n][1];for(var n in this._version=e,this._recordEnable=!1,i)null===(e=i[n])?this.removeValue(n):this.setValue(n,e);this._recordEnable=!0}else this._versionAlias=""}},{key:"versionAlias",get:function(){return this._versionAlias}},{key:"lastVersion",get:function(){return this._repository.length}},{key:"versionAliases",get:function(){var e=[];for(var t in this._versionAliases)e.push(t);return e}},{key:"commit",value:function(e){for(var t in this._repository.length=this._version,this._versionAliases)this._versionAliases[t]>this._version&&delete this._versionAliases[t];return this._repository.push(this._changeList),this._changeList={},this._version++,"string"==typeof e&&(this._versionAlias=e,this._versionAliases[e]=this._version),this}},{key:"restore",value:function(e,t){return void 0===e&&(e=""!==this._versionAlias?this._versionAlias:this._version),void 0===t&&(t=!1),t&&(this.version=0),this.version=e,this}},{key:"reset",value:function(){return this.restore(0),this._repository.length=0,v(this._versionAliases),this}},{key:"onValueChange",value:function(e,t,r,i){this._recordEnable&&(this._changeList.hasOwnProperty(t)?this._changeList[t][0]=r:this._changeList[t]=[r,i])}}]),a}();return function(){n(r,Phaser.Plugins.BasePlugin);var t=c(r);function r(e){return u(this,r),t.call(this,e)}return e(r,[{key:"start",value:function(){this.game.events.on("destroy",this.destroy,this)}},{key:"add",value:function(e,t,r){return new o(e,t,r)}}]),r}()});
